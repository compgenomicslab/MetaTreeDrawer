<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explore Tree: {{treename}}</title>
    <!-- Bootstrap CSS and other dependencies -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/jquery.min.js"></script>
    <style>
        /* Floating control panel */
        .control-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 280px;
            padding: 15px;
            background-color: #f8f9fa;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        /* Minimized state */
        .control-panel.minimized {
            transform: translateY(-100%);
        }

        /* Control panel tab */
        .control-panel-tab {
            position: fixed;
            top: 0;
            right: 20px;
            padding: 10px;
            background-color: #007bff;
            color: white;
            border-radius: 0 0 5px 5px;
            cursor: pointer;
            font-weight: bold;
            z-index: 1001;
            text-align: center;
        }
        
        .control-panel-footer {
            display: flex;
            justify-content: space-between;
            padding-top: 10px;
            border-top: 1px solid #ddd;
            margin-top: 20px;
        }

        /* Fullscreen button styling */
        .fullscreen-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1002;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Toggle Button for Control Panel -->
    <div class="control-panel-tab" id="controlPanelTab">â‰£</div>

    <!-- Floating Control Panel -->
    <div class="control-panel" id="controlPanel">
        <h5>Control Panel</h5>
        <form id="controlPanelForm" method="POST" action="/explore_tree/{{treename}}">
            <button type="button" class="btn btn-primary mb-3" id="addLayoutBtn">Add Layout</button>
            <div id="layoutSelection" class="form-group" style="display: none;">
                <label for="layout">Select Layout Option:</label>
                <select class="form-control" id="layout" name="layout">
                    <optgroup label="Categorical">
                        <option value="colorbranch-layout">Color Branch Layout</option>
                        <option value="label-layout">Label Layout</option>
                        <option value="rectangle-layout" selected>Rectangular Layout</option>
                        <option value="categorical-bubble-layout">Bubble Layout</option>
                        <option value="background-layout">Background Layout</option>
                        <option value="categorical-matrix-layout">Categorical Matrix Layout</option>
                        <option value="piechart-layout">Piechart Layout</option>
                        <option value="profiling-layout">Profiling Layout</option>
                    </optgroup>
                    <optgroup label="Binary">
                        <option value="binary-layout">Binary Layout</option>
                        <option value="binary-matrix-layout">Binary Matrix Layout</option>
                        <option value="binary-aggregate-layout">Binary Aggregate Layout</option>
                        <option value="binary-unicolor-layout">Binary Unicolor Layout</option>
                        <option value="binary-unicolor-aggregate-layout">Binary Unicolor Aggregate Layout</option>
                    </optgroup>
                    <optgroup label="Numerical">
                        <option value="branchscore-layout">Color Branch Layout</option>
                        <option value="heatmap-layout">Heatmap Layout</option>
                        <option value="heatmap-mean-layout">Heatmap Mean Layout</option>
                        <option value="heatmap-zscore-layout">Heatmap Z-Score Layout</option>
                        <option value="barplot-layout">Barplot Layout</option>
                        <option value="numerical-matrix-layout">Numerical Matrix Layout</option>
                        <option value="numerical-bubble-layout">Bubble Layout</option>
                    </optgroup>
                    <optgroup label="Analytic"> 
                        <option value="acr-discrete-layout">ACR Discrete Layout</option>
                        <option value="acr-continuous-layout">ACR Continuous Layout</option>
                        <option value="ls-layout">LS Layout</option>
                    </optgroup>
                    <optgroup label="Taxonomy">  
                        <option value="taxonclade-layout">Taxon Clade Layout</option>
                        <option value="taxonrectangle-layout">Taxon Rectangle Layout</option>
                        <option value="taxoncollapse-layout">Taxon Collapse Layout</option>
                    </optgroup>
                    <option value="emapper-layout">EggNOG-mapper Layout</option>
                    <option value="domain-layout">Domain Layout</option>
                    <option value="alignment-layout">Alignment Layout</option>
                </select>
            </div>

            <div id="propsSelection" class="form-group mt-3" style="display: none;">
                <label for="props">Select Properties to Visualize:</label>
                <select multiple class="form-control" id="props" name="props">
                    % for prop in tree_info['node_props']:
                        <option value="{{ prop }}">{{ prop }}</option>
                    % end
                </select>
                <small class="form-text text-muted">Hold down Ctrl (Windows) or Command (Mac) to select multiple options.</small>
            </div>
            <div id="applyButton" class="mt-4" style="display: none;">
                <button type="submit" class="btn btn-success">Apply Visualization</button>
            </div>
        </form>
        <div class="mt-4">
            <h5>Current Layouts</h5>
            <ul id="currentLayouts">
                % if tree_info['layouts']:
                    % for layout in tree_info['layouts']:
                        <li>{{ layout.name }}</li>
                    % end
                % else:
                    <li><em>No layouts added yet.</em></li>
                % end
            </ul>
        </div>

        <!-- Control Panel Footer -->
        <div class="control-panel-footer mt-4">
            <button class="btn btn-primary" onclick="window.location.reload();">Refresh</button>
            <button class="btn btn-secondary" id="fullscreenBtn">Fullscreen</button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mt-4">
        <h1>Explore Tree: {{treename}}</h1>

        <!-- Iframe container -->
        <div class="position-relative mt-3">
            
            <iframe src="http://localhost:5050" id="treeIframe" width="100%" height="800px" frameborder="0" allowfullscreen></iframe>
            
        </div>

        <a href="/">Go back to upload</a>
    </div>

    <script>
        // Control Panel Toggle
        document.getElementById('controlPanelTab').addEventListener('click', function() {
            var controlPanel = document.getElementById('controlPanel');
            controlPanel.classList.toggle('minimized');
        });

        // Show layout and properties selection on Add Layout button click
        document.getElementById('addLayoutBtn').addEventListener('click', function() {
            document.getElementById('layoutSelection').style.display = 'block';
            document.getElementById('propsSelection').style.display = 'block';
            document.getElementById('applyButton').style.display = 'block';
        });

        // Fullscreen Toggle for Iframe
        document.getElementById('fullscreenBtn').addEventListener('click', function() {
            var iframe = document.getElementById('treeIframe');
            if (!document.fullscreenElement) {
                iframe.requestFullscreen().catch(err => {
                    alert(`Error attempting to enable full-screen mode: ${err.message}`);
                });
            } else {
                document.exitFullscreen();
            }
        });
    </script>
</body>
</html>
