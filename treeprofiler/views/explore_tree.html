<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explore Tree: {{treename}}</title>
    <!-- Bootstrap CSS and other dependencies -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet"/>
    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Include Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <!-- Include Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <style>
        /* Floating control panel */
        .control-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 280px;
            max-height: 80vh; /* Set a maximum height to trigger scrolling */
            padding: 15px;
            background-color: #f8f9fa;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            z-index: 1000;
            transition: transform 0.3s ease;
            overflow-y: auto; /* Enable vertical scrolling */
            resize: horizontal; /* Allow horizontal resizing */
            border: 1px solid #ccc; /* Add a border for better visual feedback */
        }
    
        /* Minimized state */
        .control-panel.minimized {
            transform: translateY(-100%);
        }
    
        /* Control panel tab */
        .control-panel-tab {
            position: fixed;
            top: 0;
            right: 20px;
            padding: 10px;
            background-color: #007bff;
            color: white;
            border-radius: 0 0 5px 5px;
            cursor: pointer;
            font-weight: bold;
            z-index: 1001;
            text-align: center;
        }
        
        .control-panel-footer {
            display: flex;
            justify-content: space-between;
            padding-top: 10px;
            border-top: 1px solid #ddd;
            margin-top: 20px;
        }
    
        /* Fullscreen button styling */
        .fullscreen-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1002;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Toggle Button for Control Panel -->
    <div class="control-panel-tab" id="controlPanelTab">â‰£</div>

    <!-- Floating Control Panel -->
    <div class="control-panel" id="controlPanel">
        <h5>Control Panel</h5>
        <form id="controlPanelForm" method="POST" action="/explore_tree/{{treename}}">
            <!-- Layout Selection -->
            <button type="button" class="btn btn-primary mb-3" id="addLayoutBtn">Layout Settings</button>
            <div id="layoutSelection" class="form-group" style="display: none;">
                <h5>Select Layout Option</h5>
                <select class="form-control" id="layout" name="layout">
                    <optgroup label="Categorical">
                        <option value="colorbranch-layout" selected>Color Branch Layout</option>
                        <option value="label-layout">Label Layout</option>
                        <option value="rectangle-layout">Rectangular Layout</option>
                        <option value="categorical-bubble-layout">Bubble Layout</option>
                        <option value="background-layout">Background Layout</option>
                        <option value="categorical-matrix-layout">Categorical Matrix Layout</option>
                        <option value="piechart-layout">Piechart Layout</option>
                        <option value="profiling-layout">Profiling Layout</option>
                    </optgroup>
                    <optgroup label="Binary">
                        <option value="binary-layout">Binary Layout</option>
                        <option value="binary-matrix-layout">Binary Matrix Layout</option>
                        <option value="binary-aggregate-layout">Binary Aggregate Layout</option>
                        <option value="binary-unicolor-layout">Binary Unicolor Layout</option>
                        <option value="binary-unicolor-aggregate-layout">Binary Unicolor Aggregate Layout</option>
                    </optgroup>
                    <optgroup label="Numerical">
                        <option value="branchscore-layout">Color Branch Layout</option>
                        <option value="heatmap-layout">Heatmap Layout</option>
                        <option value="heatmap-mean-layout">Heatmap Mean Layout</option>
                        <option value="heatmap-zscore-layout">Heatmap Z-Score Layout</option>
                        <option value="barplot-layout">Barplot Layout</option>
                        <option value="numerical-matrix-layout">Numerical Matrix Layout</option>
                        <option value="numerical-bubble-layout">Bubble Layout</option>
                    </optgroup>
                    <optgroup label="Analytic"> 
                        <option value="acr-discrete-layout">ACR Discrete Layout</option>
                        <option value="acr-continuous-layout">ACR Continuous Layout</option>
                        <option value="ls-layout">LS Layout</option>
                    </optgroup>
                    <optgroup label="Taxonomy">  
                        <option value="taxonclade-layout">Taxon Clade Layout</option>
                        <option value="taxonrectangle-layout">Taxon Rectangle Layout</option>
                        <option value="taxoncollapse-layout">Taxon Collapse Layout</option>
                    </optgroup>
                    <option value="emapper-layout">EggNOG-mapper Layout</option>
                    <option value="domain-layout">Domain Layout</option>
                    <option value="alignment-layout">Alignment Layout</option>
                </select>
            </div>
    
            <!-- Properties Selection -->
            <div id="propsSelection" class="form-group mt-3" style="display: none;">
                <label for="props">Select Properties to Visualize:</label>
                <select multiple class="form-control" id="props" name="props">
                    % for prop in tree_info['node_props']:
                        <option value="{{ prop }}">{{ prop }}</option>
                    % end
                </select>
                <small class="form-text text-muted">Hold down Ctrl (Windows) or Command (Mac) to select multiple options.</small>
            </div>
    
            <!-- Custom Query Section -->
            <div id="customQuery" class="mt-4" style="display: none;">
                <h5>Custom Query</h5>
                <div class="form-group">
                    <label for="customQueryType">Select Query Type:</label>
                    <select class="form-control" id="customQueryType" name="customQueryType">
                        <option value=""></option>
                        <option value="highlight">Highlight</option>
                        <option value="collapse">Collapse</option>
                        <option value="prune">Prune</option>
                        <option value="rank_limit">Rank Limit (for taxonomic trees only)</option>
                    </select>
                </div>
                <div id="queryFields" class="form-group mt-3">
                    <label for="queryProp">Property</label>
                    <select class="form-control" id="queryProp" name="queryProp">
                        % for prop in selected_props:
                            <option value="{{ prop }}">{{ prop }}</option>
                        % end
                    </select>
                    <div id="dynamicCounterProps"></div> <!-- Counter Prop Placeholder -->
                    <label for="queryOperation" class="mt-2">Operation</label>
                    <select class="form-control" id="queryOperation" name="queryOperation">
                        <option value="=">Equals</option>
                        <option value="!=">Not Equals</option>
                        <option value="contains">Contains</option>
                        <option value="&gt;">Greater Than</option>
                        <option value="&lt;">Less Than</option>
                    </select>
                    <label for="queryValue" class="mt-2">Value</label>
                    <input type="text" class="form-control" id="queryValue" name="queryValue" placeholder="Enter value">
                    <div class="mt-3">
                        <button type="button" class="btn btn-secondary dropdown-toggle" id="addQueryBtn">ADD</button>
                        <div id="addQueryOptions" class="dropdown-menu">
                            <a class="dropdown-item" href="#" onclick="addQueryPart('AND')">AND</a>
                            <a class="dropdown-item" href="#" onclick="addQueryPart('OR')">OR</a>
                        </div>
                    </div>
                    <textarea class="form-control mt-3" id="queryBox" name="queryBox" rows="3" readonly></textarea>
                    <small><a href="#" id="clearQueryBox" class="text-danger">Clear Query</a></small>
                </div>
            </div>
    
            <!-- Layer Management Section -->
            <div class="mt-4">
                <h5>Manage Layers</h5>
                <ul id="layerList" class="list-group mb-3"></ul>
                <button type="button" id="addLayerBtn" class="btn btn-secondary mb-3">Add Layer</button>
                <button type="button" id="applyLayersBtn" class="btn btn-success mb-3">Apply Layers</button>
            </div>
        </form>
        <div class="control-panel-footer mt-4">
            <button class="btn btn-primary" onclick="window.location.reload();">Refresh</button>
            <button class="btn btn-secondary" id="fullscreenBtn">Fullscreen</button>
        </div>
        
    </div>

    <!-- Main Content -->
    <div class="container mt-4">
        <h1>Explore Tree: {{treename}}</h1>

        <!-- Iframe container -->
        <div class="position-relative mt-3">
            <iframe src="http://localhost:5050" id="treeIframe" width="100%" height="800px" frameborder="0" allowfullscreen></iframe>
        </div>

        
    </div>

    <script>
        $(document).ready(function() {
            initializeSelect2();
            setupEventListeners();
        });
    
        /*********************
         * Initialization Functions
         *********************/
        // Initialize Select2 dropdowns
        function initializeSelect2() {
            $('#props').select2({
                placeholder: "Type to search properties",
                allowClear: true,
                width: '100%'
            });
    
            $('#queryProp').select2({
                placeholder: "Type to search properties",
                allowClear: true,
                width: '100%'
            });
        }
    
        // Set up event listeners for UI elements
        function setupEventListeners() {
            document.getElementById('controlPanelTab').addEventListener('click', toggleControlPanel);
            document.getElementById('addLayoutBtn').addEventListener('click', showLayoutOptions);
            document.getElementById('customQueryType').addEventListener('change', toggleQueryFields);
            document.getElementById('clearQueryBox').addEventListener('click', clearQueryBox);
            document.getElementById('addQueryBtn').addEventListener('click', addInitialQueryPart);
            document.getElementById('addLayerBtn').addEventListener('click', addLayer);
            document.getElementById('applyLayersBtn').addEventListener('click', applyLayers);
            $('#queryProp').on('select2:select', handleDynamicCounterInput);
            $('#queryProp').on('select2:unselect', removeCounterInputField);
        }
    
        /*********************
         * UI Toggle Functions
         *********************/
        function toggleControlPanel() {
            document.getElementById('controlPanel').classList.toggle('minimized');
        }
    
        function showLayoutOptions() {
            document.getElementById('layoutSelection').style.display = 'block';
            document.getElementById('propsSelection').style.display = 'block';
            document.getElementById('customQuery').style.display = 'block';
        }
    
        function toggleQueryFields() {
            const queryType = document.getElementById('customQueryType').value;
            const queryFields = document.getElementById('queryFields');
            const taxonomicOptions = document.getElementById('taxonomicOptions');
    
            if (queryType === 'rank_limit') {
                queryFields.style.display = 'none';
                taxonomicOptions.style.display = 'block';
            } else {
                queryFields.style.display = 'block';
                taxonomicOptions.style.display = 'none';
            }
            resetQueryButton();
        }
    
    
        /*********************
         * Layer Management Functions
         *********************/
        let layers = [];
    
        function addLayer() {
            const layout = document.getElementById('layout').value;
            const props = $('#props').val();
            const queryType = document.getElementById('customQueryType').value;
            const query = document.getElementById('queryBox').value;
    
            const layer = { layout, props, queryType, query };
            layers.push(layer);
            renderLayers();
            clearInputs();
        }
    
        function renderLayers() {
            const layerList = document.getElementById('layerList');
            layerList.innerHTML = '';
    
            layers.forEach((layer, index) => {
                const layerItem = document.createElement('li');
                layerItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                layerItem.textContent = `Layer ${index + 1}: ${layer.layout} (${layer.queryType || 'No Query'})`;
    
                const deleteButton = document.createElement('button');
                deleteButton.className = 'btn btn-sm btn-danger';
                deleteButton.textContent = 'Delete';
                deleteButton.onclick = () => {
                    layers.splice(index, 1);
                    renderLayers();
                };
    
                layerItem.appendChild(deleteButton);
                layerList.appendChild(layerItem);
            });
        }
    
        function clearInputs() {
            document.getElementById('layout').value = '';
            $('#props').val(null).trigger('change');
            document.getElementById('customQueryType').value = '';
            document.getElementById('queryBox').value = '';
        }
    
        function applyLayers() {
            const layersData = JSON.stringify(layers);
            $.post('/explore_tree/{{treename}}', { layers: layersData }, function(response) {
                console.log('Layers applied:', layersData);
                window.location.reload();
            });
        }
    
        /*********************
         * Query Management Functions
         *********************/
        let queryParts = [];
    
        function resetQueryButton() {
            document.getElementById('addQueryBtn').innerText = 'ADD';
            document.getElementById('addQueryOptions').style.display = 'none';
            queryParts = [];
            document.getElementById('queryBox').value = '';
        }
    
        function addInitialQueryPart() {
            if (document.getElementById('queryBox').value === '') {
                addQueryPart();
            }
        }
    
        function addQueryPart(operator = '') {
            const queryType = document.getElementById('customQueryType').value;
            const prop = document.getElementById('queryProp').value.trim();
            const operation = document.getElementById('queryOperation').value;
            const value = document.getElementById('queryValue').value.trim();
            const counterInputElement = document.querySelector('.counter-input');
            const counterValue = counterInputElement ? counterInputElement.value : null;
    
            if (!prop || !value) {
                alert("Please fill in all query fields.");
                resetQueryButton();
                return;
            }
    
            const queryPart = counterValue ? `${prop}:${counterValue} > ${value}` : `${prop} ${operation} ${value}`;
            queryParts.push(queryPart);
            document.getElementById('queryBox').value = queryParts.join(' ') + ';';
    
            document.getElementById('addQueryBtn').innerText = 'AND';
            document.getElementById('addQueryOptions').style.display = 'block';
    
            document.getElementById('queryProp').value = '';
            document.getElementById('queryValue').value = '';
            document.getElementById('addQueryOptions').style.display = 'none';
        }
    
        /*********************
         * Additional Input Handlers
         *********************/
        function handleDynamicCounterInput(e) {
            var selectedProperty = e.params.data.id;
            if (selectedProperty.endsWith('_counter')) {
                const counterField = `
                    <div class="form-group" id="input-${selectedProperty}">
                        <label for="counterInput">Prop for ${selectedProperty}</label>
                        <input type="text" class="form-control counter-input"
                            id="counterInput"
                            data-prop="${selectedProperty}"
                            placeholder="Enter Counter prop">
                    </div>`;
                $('#dynamicCounterProps').append(counterField);
            }
        }
    
        function removeCounterInputField(e) {
            const unselectedProperty = e.params.data.id;
            if (unselectedProperty.endsWith('_counter')) {
                $(`#input-${unselectedProperty}`).remove();
                $('#queryResult').val('');
            }
        }
    
        function clearQueryBox(event) {
            event.preventDefault();
            document.getElementById('queryBox').value = '';
            queryParts = [];
            resetQueryButton();
        }
    </script>
    <script>
        <!-- Fullscreen Button Script -->
        const togglebtn = document.getElementById("fullscreenBtn");
        const iframe = document.getElementById("treeIframe");

        togglebtn.addEventListener("click", function() {
            if(iframe.requestFullscreen){
                iframe.requestFullscreen();
            }else if(iframe.mozRequestFullScreen){ // Firefox
                iframe.mozRequestFullScreen();
            }else if(iframe.webkitRequestFullscreen){ // Chrome,Safari,Opera
                iframe.webkitRequestFullscreen();
            }else if(iframe.msRequestFullscreen){ // I.E, Edge
                iframe.msRequestFullscreen();
            }
        });
    </script>    
</body>
</html>