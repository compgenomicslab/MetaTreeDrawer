<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Tree</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/jquery.min.js"></script>
</head>
<body>

<div class="container mt-5">
    <h1>Upload a New Tree</h1>
    <form id="uploadTreeForm" enctype="multipart/form-data">
        <div class="form-group">
            <label for="treename">Tree Name</label>
            <input type="text" class="form-control" id="treename" name="treename" placeholder="Enter Tree Name" value="test" required>
        </div>
        <div class="form-group">
            <label for="tree">Tree Newick Format</label>
            <textarea class="form-control" id="tree" name="tree" rows="5" placeholder="Enter tree in Newick format">
((Taxa_3:0.219065,(Taxa_4:0.188681,Taxa_2:0.5196)0.166914:0.90365)0.138062:0.0632016,(Taxa_0:0.190563,Taxa_1:0.458423)0.138062:0.97338);
            </textarea>
            <small class="form-text text-muted">Or upload a Newick file below.</small>
            <input type="file" class="form-control-file mt-2" id="treeFile" name="treeFile">
        </div>
        <div class="form-group">
            <label for="metadata">Metadata (Optional)</label>
            <textarea class="form-control" id="metadata" name="metadata" rows="5" placeholder="Enter metadata">
name,random_column1,random_column2,random_column3,categorical1,binary1
Taxa_0,0.45303222603186877,1.9801547427961053,43,A,True
Taxa_1,0.3276816717486982,2.901485035789767,18,B,False
Taxa_2,0.7817176831389784,0.8169962886608579,88,B,True
Taxa_3,0.538278090458638,-2.9731013860390583,95,C,False
Taxa_4,0.5915676489932427,-2.0927680151507433,17,C,False
            </textarea>
            <small class="form-text text-muted">Or upload a metadata file below.</small>
            <input type="file" class="form-control-file mt-2" id="metadataFile" name="metadataFile">
        </div>
        <div class="form-group row">
            <label for="separator" class="col-sm-3 col-form-label">Metadata Separator</label>
            <div class="col-sm-3">
                <input type="text" class="form-control" id="separator" name="separator" placeholder="<tab>" value="<tab>">
            </div>
            <small class="form-text text-muted">Specify the metadata file separator; (default is "&lt;tab&gt;", for a comma-separated file put ",")</small>
        </div>
        <div class="form-group">
            <label for="alignment">Alignment (Optional)</label>
            <textarea class="form-control" id="alignment" name="alignment" rows="5" placeholder="Enter alignment"></textarea>
            <small class="form-text text-muted">Or upload a metadata file below.</small>
            <input type="file" class="form-control-file mt-2" id="alignmentFile" name="alignmentFile">
        </div>
        <div class="form-group">
            <label for="pfam">Pfam annotation from emapper (Optional)</label>
            <small class="form-text text-muted">Or upload a pfam annotation file from emapper below.</small>
            <input type="file" class="form-control-file mt-2" id="pfamFile" name="pfamFile">
        </div>
        <button type="button" class="btn btn-primary" onclick="submitForm()">Upload Tree and Metadata</button>
    </form>
</div>

<script>
    const CHUNK_SIZE = 1024 * 1024; // 1MB

    async function submitForm() {
        const treename = document.getElementById('treename').value;
        const treeTextarea = document.getElementById('tree').value;
        const metadataTextarea = document.getElementById('metadata').value;
        const alignmentTextarea = document.getElementById('alignment').value;
        const treeFile = document.getElementById('treeFile').files[0];
        const metadataFile = document.getElementById('metadataFile').files[0];
        const alignmentFile = document.getElementById('alignmentFile').files[0];
        const pfamFile = document.getElementById('pfamFile').files[0];
        const separator = document.getElementById('separator').value;

        if (!treename) {
            alert("Please enter a tree name.");
            return;
        }

        const formData = new FormData();
        formData.append("treename", treename);

        // Upload tree data
        if (treeFile) {
            await uploadFileInChunks(treeFile, 'treeFile', treename);
        } else if (treeTextarea) {
            formData.append("tree", treeTextarea);
        } else {
            alert("Please provide tree data in Newick format or upload a file.");
            return;
        }

        // Upload metadata if provided
        if (metadataFile) {
            await uploadFileInChunks(metadataFile, 'metadataFile', treename);
        } else if (metadataTextarea) {
            formData.append("metadata", metadataTextarea);
        }
        if (separator) {
            formData.append("separator", separator);
        }
        
        // Upload metadata if provided
        if (alignmentFile) {
            await uploadFileInChunks(alignmentFile, 'alignmentFile', treename);
        } else if (alignmentTextarea) {
            formData.append("alignment", alignmentTextarea);
        }

        // Upload pfam annotation if provided
        if (pfamFile) {
            await uploadFileInChunks(pfamFile, 'pfamFile', treename);
        }

        // Final submission with the text data
        fetch('/upload', {
            method: 'POST',
            body: formData
        }).then(response => response.text()).then(result => {
            window.location.href = `/tree/${treename}`;  // Redirect to /tree/<name> after completion
        }).catch(error => {
            console.error("Error uploading files:", error);
            alert("Error occurred during upload.");
        });
    }

    async function uploadFileInChunks(file, fieldName, treename) {
        const totalChunks = Math.ceil(file.size / CHUNK_SIZE);

        for (let chunkIndex = 0; chunkIndex < totalChunks; chunkIndex++) {
            const start = chunkIndex * CHUNK_SIZE;
            const end = Math.min(file.size, start + CHUNK_SIZE);
            const chunk = file.slice(start, end);

            const chunkFormData = new FormData();
            chunkFormData.append("treename", treename);
            chunkFormData.append(fieldName, chunk);
            chunkFormData.append("chunkIndex", chunkIndex);
            chunkFormData.append("totalChunks", totalChunks);

            await fetch('/upload_chunk', {
                method: 'POST',
                body: chunkFormData
            });
        }
    }
</script>
</body>
</html>
