<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Tree</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/jquery.min.js"></script>
</head>
<body>

<div class="container mt-5">
    <h1>Upload a New Tree</h1>
    
    <form id="uploadTreeForm" enctype="multipart/form-data">
        
        <!-- Tree Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Tree</h5>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="treename">Tree Name</label>
                    <input type="text" class="form-control" id="treename" name="treename" placeholder="Enter Tree Name" value="test" required>
                </div>
                <div class="form-group">
                    <label for="tree">Tree Newick Format</label>
                    <textarea class="form-control" id="tree" name="tree" rows="5" placeholder="Enter tree in Newick format">
((Taxa_3:0.219065,(Taxa_4:0.188681,Taxa_2:0.5196)0.166914:0.90365)0.138062:0.0632016,(Taxa_0:0.190563,Taxa_1:0.458423)0.138062:0.97338);
                    </textarea>
                    <small class="form-text text-muted">Or upload a Newick file below.</small>
                    <input type="file" class="form-control-file mt-2" id="treeFile" name="treeFile">
                </div>
                <div class="form-group">
                    <label for="treeparser">Tree Parser</label>
                    <select class="form-control" id="treeparser" name="treeparser" required>
                        <option value="name" >Name</option>
                        <option value="support" selected>Support</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Taxonomic Annotation Section -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Taxonomic Annotation (Optional)</h5>
                <button type="button" class="btn btn-secondary btn-sm" id="toggleTaxonomicBtn">Activate Taxonomic Annotation</button>
            </div>
            <div id="taxonomicSection" class="card-body collapsed" style="display: none;">
                <div class="form-group row mt-3">
                    <!-- Taxonomic ID Column -->
                    <div class="col-md-2">
                        <label for="taxonomicIdColumn">Taxonomic ID Column</label>
                        <select class="form-control" id="taxonomicIdColumn" name="taxonomicIdColumn">
                            <!-- Add column options dynamically based on metadata -->
                            <option value="name">name</option>
                        </select>
                    </div>
                    
                    <!-- Taxa DB -->
                    <div class="col-md-2">
                        <label for="taxaDb">Taxa DB</label>
                        <select class="form-control" id="taxaDb" name="taxaDb" onchange="updateVersionOptions()">
                            <option value="NCBI">NCBI</option>
                            <option value="GTDB">GTDB</option>
                        </select>
                    </div>
                    
                    <!-- Version -->
                    <div class="col-md-2">
                        <label for="version">Version</label>
                        <select class="form-control" id="version" name="version">
                            <option value="-">-</option>
                        </select>
                    </div>

                    <!-- Species Field Delimiter -->
                    <div class="col-md-2">
                        <label for="speciesFieldDelimiter">Species Field Delimiter</label>
                        <input type="text" class="form-control" id="speciesFieldDelimiter" name="speciesFieldDelimiter" value=".">
                    </div>
                    
                    <!-- Species Field Index -->
                    <div class="col-md-2">
                        <label for="speciesFieldIndex">Species Field Index</label>
                        <input type="text" class="form-control" id="speciesFieldIndex" name="speciesFieldIndex" placeholder="Enter index" value="0">
                    </div>

                     <!-- ignore unclassified -->
                     <div class="col-md-2">
                        <label for="ignoreUnclassified">ignore unclassified</label>
                        <select class="form-control" id="ignoreUnclassified" name="ignoreUnclassified">
                            <option value="False">False</option>
                            <option value="True">True</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <!-- End -->

        <!-- Metadata Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Metadata (Optional)</h5>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="metadata">Metadata File</label>
                    <small class="form-text text-muted">Or upload a metadata file below.</small>
                    <input type="file" class="form-control-file mt-2" id="metadataFile" name="metadataFile">
                </div>
                <div class="form-group row mt-3">
                    <label for="separator" class="col-sm-3 col-form-label">Metadata Separator</label>
                    <div class="col-sm-3">
                        <input type="text" class="form-control" id="separator" name="separator" placeholder="<tab>" value="<tab>">
                    </div>
                    <small class="form-text text-muted">Specify the metadata file separator (default is "&lt;tab&gt;", for comma use ",").</small>
                </div>
                <div class="mt-3">
                    <button type="button" class="btn btn-secondary" id="parseMetadataBtn">Parsing metadata</button>
                </div>
                <div id="metadataAnalysis" class="mt-3" style="display: none;">
                    <h6>Detected Column Types:</h6>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Column</th>
                                <th>Data Type</th>
                                <th>Summary Method for Ancestor Nodes</th>
                            </tr>
                        </thead>
                        <tbody id="columnTypeList"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Alignment Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Alignment (Optional)</h5>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="alignment">Alignment File</label>
                    <small class="form-text text-muted">Or upload an alignment file below.</small>
                    <input type="file" class="form-control-file mt-2" id="alignmentFile" name="alignmentFile">
                </div>
            </div>
        </div>
        
        <!-- Pfam Annotation Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Pfam Annotation from emapper (Optional)</h5>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="pfam">Pfam annotation</label>
                    <small class="form-text text-muted">Or upload a Pfam annotation file from emapper below.</small>
                    <input type="file" class="form-control-file mt-2" id="pfamFile" name="pfamFile">
                </div>
            </div>
        </div>
        
        <!-- Submit Button -->
        <button type="button" class="btn btn-primary" onclick="submitForm()">Upload Tree and Metadata</button>
    </form>
</div>

<script>
    const CHUNK_SIZE = 1024 * 1024; // 1MB

    async function submitForm() {
        const treename = document.getElementById('treename').value;
        const treeTextarea = document.getElementById('tree').value;
        const treeparser = document.getElementById('treeparser').value;
        const treeFile = document.getElementById('treeFile').files[0];
        const metadataFile = document.getElementById('metadataFile').files[0];
        const alignmentFile = document.getElementById('alignmentFile').files[0];
        const pfamFile = document.getElementById('pfamFile').files[0];
        const separator = document.getElementById('separator').value;
        
        if (!treename) {
            alert("Please enter a tree name.");
            return;
        }

        const formData = new FormData();
        formData.append("treename", treename);

        if (treeFile) {
            await uploadFileInChunks(treeFile, 'treeFile', treename);
        } else if (treeTextarea) {
            formData.append("tree", treeTextarea);
        } else {
            alert("Please provide tree data in Newick format or upload a file.");
            return;
        }

        formData.append("treeparser", treeparser);

        if (metadataFile) {
            await uploadFileInChunks(metadataFile, 'metadataFile', treename);
        }
        if (separator) {
            formData.append("separator", separator);
        }
        
        // Check if taxonomic section is activated before adding fields
        const taxonomicSection = document.getElementById("taxonomicSection");
        if (!taxonomicSection.classList.contains("collapsed")) {  // Only add if section is active
            const taxonomicIdColumn = document.getElementById("taxonomicIdColumn").value;
            const taxaDb = document.getElementById("taxaDb").value;
            const version = document.getElementById("version").value;
            const speciesFieldDelimiter = document.getElementById("speciesFieldDelimiter").value;
            const speciesFieldIndex = document.getElementById("speciesFieldIndex").value;
            const ignoreUnclassified = document.getElementById("ignoreUnclassified").value;

            formData.append("taxonomicIdColumn", taxonomicIdColumn);
            formData.append("taxaDb", taxaDb);
            formData.append("version", version);
            formData.append("speciesFieldDelimiter", speciesFieldDelimiter);
            formData.append("speciesFieldIndex", speciesFieldIndex);
            formData.append("ignoreUnclassified", ignoreUnclassified);
        }
        
        const columnTypes = collectColumnTypes();
        columnTypes.text_prop.forEach(item => formData.append("text_prop[]", item));
        columnTypes.num_prop.forEach(item => formData.append("num_prop[]", item));
        columnTypes.bool_prop.forEach(item => formData.append("bool_prop[]", item));
        columnTypes.multiple_text_prop.forEach(item => formData.append("multiple_text_prop[]", item));

        const summarySelections = collectSummarySelections();
        formData.append("summary_methods", JSON.stringify(summarySelections));

        if (alignmentFile) {
            await uploadFileInChunks(alignmentFile, 'alignmentFile', treename);
        }
        if (pfamFile) {
            await uploadFileInChunks(pfamFile, 'pfamFile', treename);
        }

        fetch('/upload', {
            method: 'POST',
            body: formData
        }).then(response => response.text()).then(result => {
            window.location.href = `/tree/${treename}`;
        }).catch(error => {
            console.error("Error uploading files:", error);
            alert("Error occurred during upload.");
        });
    }

    // Function to collect summary selections with simplified values
    function collectSummarySelections() {
        const summarySelections = {};
        document.querySelectorAll('.summary-method').forEach(select => {
            const columnName = select.getAttribute('data-summary');
            let summaryMethod = select.value;

            // Simplify specific values
            if (summaryMethod === 'raw counter') {
                summaryMethod = 'raw';
            } else if (summaryMethod === 'relative counter') {
                summaryMethod = 'relative';
            }

            summarySelections[columnName] = summaryMethod;
        });
        return summarySelections;
    }

    document.getElementById('parseMetadataBtn').addEventListener('click', async () => {
        const file = document.getElementById('metadataFile').files[0];
        if (file) {
            const separator = document.getElementById('separator').value === "<tab>" ? "\t" : document.getElementById('separator').value;
            const text = await file.text();
            parseMetadata(text, separator);
        } else {
            alert("Please select a metadata file first.");
        }
    });

    function parseMetadata(text, separator) {
        const rows = text.trim().split('\n');
        if (rows.length < 2) {
            alert("Metadata file is too short to analyze.");
            return;
        }

        const headers = rows[0].split(separator);
        const columnData = headers.map(() => []);

        rows.slice(1).forEach(row => {
            const cells = row.split(separator);
            cells.forEach((cell, index) => {
                columnData[index].push(cell.trim());
            });
        });

        updateTaxonomicIdOptions(headers);  // Call the function to update options with metadata columns

        const columnTypes = headers.map((header, index) => {
            return {
                column: header,
                type: index === 0 ? "Node ID Column" : detectColumnType(columnData[index])
            };
        });

        const columnTypeList = document.getElementById('columnTypeList');
        columnTypeList.innerHTML = "";

        columnTypes.forEach((col, index) => {
            const row = document.createElement('tr');
            const columnCell = document.createElement('td');
            columnCell.textContent = col.column;
            row.appendChild(columnCell);

            const typeCell = document.createElement('td');
            if (index === 0) {
                typeCell.textContent = "Node ID Column";
            } else {
                typeCell.innerHTML = `
                    <select class="form-control-sm" data-column="${col.column}" onchange="updateSummaryOptions(this)">
                        <option value="Categorical" ${col.type === 'Categorical' ? 'selected' : ''}>Categorical</option>
                        <option value="List" ${col.type === 'List' ? 'selected' : ''}>List</option>
                        <option value="Numerical" ${col.type === 'Numerical' ? 'selected' : ''}>Numerical</option>
                        <option value="Binary" ${col.type === 'Binary' ? 'selected' : ''}>Binary</option>
                    </select>
                `;
            }
            row.appendChild(typeCell);

            const summaryCell = document.createElement('td');
            if (index === 0) {
                summaryCell.textContent = "-";
            } else {
                summaryCell.innerHTML = `
                    <select class="form-control-sm summary-method" data-summary="${col.column}">
                        ${generateSummaryOptions(col.type)}
                    </select>
                `;
            }
            row.appendChild(summaryCell);

            columnTypeList.appendChild(row);
        });
        document.getElementById('metadataAnalysis').style.display = 'block';
    }

    function updateTaxonomicIdOptions(columns) {
        const taxonomicIdColumn = document.getElementById('taxonomicIdColumn');
        taxonomicIdColumn.innerHTML = "";  // Clear existing options

        columns.forEach(col => {
            const option = document.createElement('option');
            option.value = col;
            option.textContent = col;
            taxonomicIdColumn.appendChild(option);
        });
    }

    function updateVersionOptions() {
        const taxaDb = document.getElementById("taxaDb").value;
        const versionSelect = document.getElementById("version");

        // Clear current options
        versionSelect.innerHTML = "";

        if (taxaDb === "GTDB") {
            // Add GTDB versions
            const gtdbVersions = ["95", "202", "207", "214", "220"];
            gtdbVersions.forEach(version => {
                const option = document.createElement("option");
                option.value = version;
                option.text = version;
                versionSelect.appendChild(option);
            });
        } else {
            // Default option for NCBI
            const defaultOption = document.createElement("option");
            defaultOption.value = "-";
            defaultOption.text = "-";
            versionSelect.appendChild(defaultOption);
        }
    }

    function generateSummaryOptions(type) {
        const options = {
            Numerical: ["all", "sum", "avg", "max", "min", "std", "none"],
            Categorical: ["raw counter", "relative counter", "none"],
            Binary: ["raw counter", "relative counter", "none"],
            List: ["raw counter", "relative_counter","none"],
        };
        return options[type] ? options[type].map(opt => `<option value="${opt}">${opt}</option>`).join('') : '<option value="none">none</option>';
    }

    function updateSummaryOptions(selectElem) {
        const column = selectElem.getAttribute('data-column');
        const type = selectElem.value;
        const summarySelect = document.querySelector(`select[data-summary="${column}"]`);
        summarySelect.innerHTML = generateSummaryOptions(type);
    }

    function detectColumnType(values) {
        const uniqueValues = [...new Set(values)];
        const isBinary = uniqueValues.length === 2 && uniqueValues.every(val => ["0", "1", "true", "false", "t", "f"].includes(val.toLowerCase()));
        const isNumeric = uniqueValues.every(val => !isNaN(val));
        const isTaxonomic = uniqueValues.every(val => /^[A-Z][a-z]+(?:\s[a-z]+)?$/.test(val));
        
        if (isNumeric) return "Numerical";
        else if (isBinary) return "Binary";
        else if (isTaxonomic) return "Taxonomic";
        else return "Categorical";
    }

    function collectColumnTypes() {
        const text_prop = [];
        const num_prop = [];
        const bool_prop = [];
        const multiple_text_prop = [];

        document.querySelectorAll('#columnTypeList select').forEach(select => {
            const colName = select.getAttribute('data-column');
            const type = select.value;

            if (type === 'Numerical') num_prop.push(colName);
            else if (type === 'Binary') bool_prop.push(colName);
            else if (type === 'List') multiple_text_prop.push(colName);
            else text_prop.push(colName);
        });

        return { text_prop, num_prop, bool_prop, multiple_text_prop};
    }

    async function uploadFileInChunks(file, fieldName, treename) {
        const totalChunks = Math.ceil(file.size / CHUNK_SIZE);

        for (let chunkIndex = 0; chunkIndex < totalChunks; chunkIndex++) {
            const start = chunkIndex * CHUNK_SIZE;
            const end = Math.min(file.size, start + CHUNK_SIZE);
            const chunk = file.slice(start, end);

            const chunkFormData = new FormData();
            chunkFormData.append("treename", treename);
            chunkFormData.append(fieldName, chunk);
            chunkFormData.append("chunkIndex", chunkIndex);
            chunkFormData.append("totalChunks", totalChunks);

            await fetch('/upload_chunk', {
                method: 'POST',
                body: chunkFormData
            });
        }
    }
    // Toggle visibility of taxonomic annotation section
    document.getElementById("toggleTaxonomicBtn").addEventListener("click", () => {
        const taxonomicSection = document.getElementById("taxonomicSection");
        const isCollapsed = taxonomicSection.classList.toggle("collapsed");
        taxonomicSection.style.display = isCollapsed ? "none" : "block";
    });
</script>
</body>
</html>

